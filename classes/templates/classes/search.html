{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-4">
            <div class="card">
                <h5 class="card-header bg-warning">
                    Class Search
                </h5>
                <div class="container" id="search_div">
                    <br>
                    <!-- <form action="#" method="POST"> -->
                    <!-- {% csrf_token %} -->
                    <!-- <label for="search">Search Class Name</label> -->
                    {{ form.media }}
                    {{ form|crispy }}
                    <input type="hidden" name="csrfToken" value="{{ csrf_token }}">
                    <button class="btn btn-dark btn-block" id="search_button" onclick="search();">Search</button>
                    <br>
                </div>
            </div>
        </div>
        <div class="col-8 text-center">
            <table class="table dt-responsive table-striped" cellspacing="0" width="100%">
                <thead class="thead-dark">
                    <tr>
                        <th>Course Number</th>
                        <th>Course Title</th>
                        <th>Credits</th>
                        <!-- <th>Section #</th>
                        <th>Instructor</th>
                        <th>Time</th>
                        <th>Room</th> -->
                    </tr>
                </thead>
                <tbody id="result_table">

                </tbody>
            </table>
        </div>
        <!-- <div class="col-5 text-center">
            Column Three
        </div> -->
    </div>
</div>

{% endblock %}

{% block javascript %}
<script>

    $(document).ready(function () {
        // set placeholder for department field (not working through django side)
        $("#id_department").attr("placeholder", "Any Subject");
        // retrieve values from sessionStorage
        if (typeof (Storage) !== "undefined") {
            // Code for localStorage/sessionStorage.
            $("#id_department").val(sessionStorage.getItem("dept_search"));
            $("#id_keyword").val(sessionStorage.getItem("keyword_search"));
            $('#search_button').click();
        }
    });

    $('#search_div').on('keydown', function (e) {
        var key = e.which;
        if (key == 13) {
            // alert("enter");
            $('#search_button').click();
            return false;
        }
    });

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    var search = function () {
        // Get data from form
        var keyword = $("#id_keyword").val()
        var department = $("#id_department").val()
        // save data to sessionStorage storage to retain values
        if (typeof (Storage) !== "undefined") {
            // Code for sessionStorage.
            sessionStorage.setItem("dept_search", department);
            sessionStorage.setItem("keyword_search", keyword);
        }
        if (keyword != "" || department != "") { // Fields must actually contain something
            var csrftoken = $('input[name="csrfToken"]').attr('value')
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            var data = { keyword: keyword, department: department };
            var args = {
                type: "POST", url: "{% url 'classes:search_ajax' %}", data: data
            };
            $.ajax(args).then(function (result) {
                console.log(result);
                var duplicate_check = {}
                // Code depending on result
                document.getElementById("result_table").innerHTML = "";
                var html = "";
                for (var i = 0; i < result.length; i++) {
                    if (duplicate_check[result[i].department] !== result[i].course_subject && result[i].credit != 0) {
                        html += `<tr><td><a href="{% url 'classes:view' 0 %}">${result[i].department} ${result[i].course_subject}</a></td>\
                        <td>${result[i].course_title}</td><td>${result[i].credit}</td></tr>`.replace(/0/, result[i].id);
                        duplicate_check[result[i].department] = result[i].course_subject;
                    }
                }
                document.getElementById("result_table").innerHTML = html;
            })
                .catch(function () {
                    // An error occurred
                });
        }
        else {
            // display an explanation of failure -- optional for starters
        }
        return false;
    };
</script>


{% endblock %}